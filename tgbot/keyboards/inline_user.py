# - *- coding: utf- 8 - *-
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from tgbot.services.sqlite import get_settings, get_payments, get_all_categories, get_positions, get_items, \
get_pod_category, get_pod_categories, get_position, get_positions_simple, get_items_simple
from tgbot.data import config
from tgbot.utils.utils_functions import get_admins
from tgbot.utils.translations import get_text, get_user_language

def language_selection():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data="set_language:ru"),
            InlineKeyboardButton(text="üá∫üá∏ English", callback_data="set_language:en")
        ]
    ])
    return keyboard

def language_selection_with_back(user_id):
    """–í—ã–±–æ—Ä —è–∑—ã–∫–∞ —Å –∫–Ω–æ–ø–∫–æ–π –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –ø—Ä–æ—Ñ–∏–ª—å"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data="set_language:ru"),
            InlineKeyboardButton(text="üá∫üá∏ English", callback_data="set_language:en")
        ],
        [InlineKeyboardButton(text="‚¨Ö –í–µ—Ä–Ω—É—Ç—å—Å—è", callback_data="profile:open")]
    ])
    return keyboard

def sub():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üì¢ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è", url="https://t.me/your_channel")],
        [InlineKeyboardButton(text="‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", callback_data="check_sub")]
    ])
    return keyboard

def user_menu(user_id):
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    lang = get_user_language(user_id)
    
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=get_text(lang, 'products'), callback_data="products:open")],
        [InlineKeyboardButton(text=get_text(lang, 'profile'), callback_data="profile:open")],
        [InlineKeyboardButton(text=get_text(lang, 'refill'), callback_data="refill")],
        [
            InlineKeyboardButton(text=get_text(lang, 'faq'), callback_data="FAQ"),
            InlineKeyboardButton(text=get_text(lang, 'support'), callback_data="support")
        ]
    ])
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
    if user_id in get_admins():
        keyboard.inline_keyboard.append([
            InlineKeyboardButton(text="‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", callback_data="admin_menu")
        ])

    return keyboard

def faq_inl():
    news = get_settings()['news']
    chat = get_settings()['chat']

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text=faq_chat_inl, url=chat),
            InlineKeyboardButton(text=faq_news_inl, url=news)
        ]
    ])
    return keyboard

def support_inll():
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=support_inl, url=get_settings()['support'])]
    ])
    return keyboard

def chat_inl():
    link = get_settings()['chat']
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=faq_chat_inl, url=link)]
    ])
    return keyboard

def news_inl():
    link = get_settings()['news']
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=faq_news_inl, url=link)]
    ])
    return keyboard

def profile_inl(user_id):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è"""
    lang = get_user_language(user_id)
    
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=get_text(lang, 'ref_system'), callback_data="ref_system")],
        [InlineKeyboardButton(text=get_text(lang, 'promocode'), callback_data="promocode")],
        [InlineKeyboardButton(text=get_text(lang, 'last_purchases'), callback_data="last_purchases")],
        [InlineKeyboardButton(text=get_text(lang, 'language_btn'), callback_data="change_language")],
        [InlineKeyboardButton(text=get_text(lang, 'back'), callback_data="back_to_menu")]
    ])
    return keyboard

def back_to_profile(user_id):
    """–ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –ø—Ä–æ—Ñ–∏–ª—é"""
    lang = get_user_language(user_id)

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=get_text(lang, 'back'), callback_data="profile:open")]
    ])
    return keyboard

def back_to_user_menu(user_id):
    """–ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    lang = get_user_language(user_id)

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=get_text(lang, 'back'), callback_data="back_to_menu")]
    ])
    return keyboard

def close_inl():
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=close_text, callback_data="close_text_mail")]
    ])
    return keyboard

def refill_open_inl(method, amount, payment_url, payment_id):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–ª–∞—Ç–µ–∂–∞"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üí∞ –û–ø–ª–∞—Ç–∏—Ç—å", url=payment_url)],
        [InlineKeyboardButton(text="‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç–µ–∂", callback_data=f"check_opl:{method}:{amount}:{payment_id}")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="back_to_menu")]
    ])
    return keyboard

def refill_inl():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–ø–æ—Å–æ–±–æ–≤ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è"""
    payments = get_payments()
    kb = []

    if payments:
        if payments.get('pay_yoomoney') == "True":
            kb.append([InlineKeyboardButton(text="üí≥ –ÆMoney", callback_data="refill:yoomoney")])
        if payments.get('pay_lava') == "True":
            kb.append([InlineKeyboardButton(text="üåã Lava", callback_data="refill:lava")])
        if payments.get('pay_crystal') == "True":
            kb.append([InlineKeyboardButton(text="üíé Crystal", callback_data="refill:crystal")])
        if payments.get('pay_lolz') == "True":
            kb.append([InlineKeyboardButton(text="‚ö° Lolz", callback_data="refill:lolz")])
    
    # –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
    kb.append([InlineKeyboardButton(text="‚Çø USDT BEP-20", callback_data="refill:crypto_usdt")])
    kb.append([InlineKeyboardButton(text="üî∑ USDT Polygon", callback_data="refill:crypto_usdt_polygon")])
    kb.append([InlineKeyboardButton(text="üîµ USDT ERC-20", callback_data="refill:crypto_usdt_erc20")])
    kb.append([InlineKeyboardButton(text="‚¨Ö –ù–∞–∑–∞–¥", callback_data="back_to_menu")])

    return InlineKeyboardMarkup(inline_keyboard=kb)

def open_products():
    kb = []
    for category in get_all_categories():
        name = category['name']
        cat_id = category['id']
        kb.append([InlineKeyboardButton(text=name, callback_data=f"open_category:{cat_id}")])

    kb.append([InlineKeyboardButton(text=back, callback_data="back_to_user_menu")])
    keyboard = InlineKeyboardMarkup(inline_keyboard=kb)
    return keyboard

def open_pod_cat_positions(pod_cat_id):
    kb = []
    for pos in get_positions(pod_cat_id=pod_cat_id):
        name = pos['name']
        pos_id = pos['id']
        price = pos['price']
        items = f"{len(get_items(position_id=pos_id))}—à—Ç"
        if pos['infinity'] == "+":
            items = "[–ë–µ–∑–ª–∏–º–∏—Ç]"

        kb.append([InlineKeyboardButton(text=f"{name} | {price}$ | {items}", callback_data=f"buy_pos:{pos_id}")])

    pod_cat = get_pod_category(pod_cat_id)
    kb.append([InlineKeyboardButton(text=back, callback_data=f"open_pod_category:{pod_cat['category_id']}")])

    keyboard = InlineKeyboardMarkup(inline_keyboard=kb)
    return keyboard

def open_positions(cat_id):
    kb = []
    for pod_cat in get_pod_categories(cat_id):
        pod_cat_name = pod_cat['name']
        pod_cat_id = pod_cat['id']
        kb.append([InlineKeyboardButton(text=pod_cat_name, callback_data=f"open_pod_category:{pod_cat_id}")])

    kb.append([InlineKeyboardButton(text=back, callback_data="products:open")])
    keyboard = InlineKeyboardMarkup(inline_keyboard=kb)
    return keyboard

def pos_buy_inl(pos_id):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–∞"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="1Ô∏è‚É£", callback_data=f"buy_pos_count:{pos_id}:1")],
        [InlineKeyboardButton(text="5Ô∏è‚É£", callback_data=f"buy_pos_count:{pos_id}:5")],
        [InlineKeyboardButton(text="üî¢ –î—Ä—É–≥–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ", callback_data="buy_pos_count_custom")],
        [InlineKeyboardButton(text="‚¨Ö –ù–∞–∑–∞–¥", callback_data="products:open")]
    ])
    return keyboard

def choose_buy_items(pos_id, count):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –ö—É–ø–∏—Ç—å", callback_data=f"confirm_buy:{pos_id}:{count}")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="products:open")]
    ])
    return keyboard

def crypto_refill_inl(amount, payment_id):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∫—Ä–∏–ø—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç–µ–∂", callback_data=f"check_crypto:{amount}:{payment_id}")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"cancel_crypto:{payment_id}")]
    ])
    return keyboard

def crypto_refill_polygon_inl(amount, payment_id):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∫—Ä–∏–ø—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ Polygon"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç–µ–∂", callback_data=f"check_crypto_polygon:{amount}:{payment_id}")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"cancel_crypto:{payment_id}")]
    ])
    return keyboard

def crypto_refill_erc20_inl(amount, payment_id):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∫—Ä–∏–ø—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ ERC-20"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç–µ–∂", callback_data=f"check_crypto_erc20:{amount}:{payment_id}")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"cancel_crypto:{payment_id}")]
    ])
    return keyboard

def crypto_refill_waiting_inl(amount, payment_id):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ–∂–∏–¥–∞–Ω–∏—è –∫—Ä–∏–ø—Ç–æ–ø–ª–∞—Ç–µ–∂–∞"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞", callback_data=f"check_crypto_again:{amount}:{payment_id}")],
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"cancel_crypto_waiting:{payment_id}")]
    ])
    return keyboard

def cancel_refill_inl(user_id):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ—Ç–º–µ–Ω—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="cancel_refill")]
    ])
    return keyboard

def products_inl(user_id):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤"""
    lang = get_user_language(user_id)
    positions = get_positions_simple()
    
    kb = []
    for position in positions:
        items_count = len(get_items_simple(position['id']))
        if items_count > 0:
            button_text = f"üì¶ {position['name']} (${position['price']}) - {items_count}—à—Ç"
            kb.append([InlineKeyboardButton(text=button_text, callback_data=f"buy_pos:{position['id']}")])

    kb.append([InlineKeyboardButton(text=get_text(lang, 'back'), callback_data="back_to_menu")])

    return InlineKeyboardMarkup(inline_keyboard=kb)